javascript:
//	author:		Wicker
//	version:	3.0
//	history of changes:
//		1.0 - 31.03.2019 by PabloCanaletto
//		2.0 - 24.05.2019 by PabloCanaletto
//			fixed bugs:
//				1. negative outputs when "untouchable" > available units
//				2. keyboard shortcut in output
//			added functionalities:
//				1. worlds without archers
//				2. max_ressources setting
//				3. skip_level_1 setting
//  	3.0 - xx.xx.2025 by Wicker
//  		added an option to send teams to maximize resource income
//			teams are no longer same times for each level
//			instead level 2-4 (3-4 if level 1 skipped) timers are 
//			timer for level 1 (2 if 1 skipped) but multiplied by integer
//					
// PabloCanaletto disclaimer: 	You are free to use this script in any way you like and to submit changes.
//								I would only appreciate you to leave notification about my orginal authorship untouched
//								with the whole history of changes.

// FUNCTIONALITY
// This script fills forms in scavenge tab. It selects troops to send on consecutive levels in a way,
// so time is distributed evenly. Levels go from right to left.

// SETTINGS
// split_method - 0 for same times for each level, 1 for more income but non-same traveling times
// too small max_resources might mess with method '1'.
//
// max_ressources - max amount of resources to gather from one level (rounding may cause some reduction)
// archers - is the world with archers (1 - yes, 0 - no)
// skip_level_1 - do you want to skip 1 level (the least efficient one) when others are unlocked?
//
// untouchable - troops "invisible" for this script, to be completely ignored
// max_unit_number - at most this number of troops of a kind will be send in total
// conditional_safeguard `- troops to leave in village if possible in total, but if not, they will be send

var settings = {
	split_method: '0',
	max_ressources: '99999',
	archers: '1',
	skip_level_1: '0'
};

var settings_spear = {
	untouchable: '0',
	max_unit_number: '9999',
	conditional_safeguard: '0'
};

var settings_sword = {
	untouchable: '0',
	max_unit_number: '9999',
	conditional_safeguard: '0'
};

var settings_axe = {
	untouchable: '0',
	max_unit_number: '9999',
	conditional_safeguard: '0'
};

var settings_archer = {
	untouchable: '0',
	max_unit_number: '9999',
	conditional_safeguard: '0'
};

var settings_light = {
	untouchable: '0',
	max_unit_number: '9999',
	conditional_safeguard: '0'
};

var settings_marcher = {
	untouchable: '0',
	max_unit_number: '9999',
	conditional_safeguard: '0'
};

var settings_heavy = {
	untouchable: '0',
	max_unit_number: '9999',
	conditional_safeguard: '0'
};

function fill(unit, number) {
	let field = $(`[name=${unit}]`);
	number = Number(number);
	field.trigger('focus');
	field.trigger('keydown');
	field.val(number);
	field.trigger('keyup');
	field.trigger('change');
	field.blur();
}
var units_settings = {
	0: settings_spear,
	1: settings_sword,
	2: settings_axe,
	3: settings_archer,
	4: settings_light,
	5: settings_marcher,
	6: settings_heavy
};

var units = {
	0: 'spear',
	1: 'sword',
	2: 'axe',
	3: 'archer',
	4: 'light',
	5: 'marcher',
	6: 'heavy'
};

var units_capacity     = [25,15,10,10,80,50,50];
var to_send            = [0,0,0,0,0,0,0];

var doc=document;
url=doc.URL;
if(url.indexOf('screen=place')==-1 || url.indexOf('mode=scavenge')==-1)
	alert('Skrypt do użycia w placu w zakładce zbieractwo');
else{
	var unfree_levels = doc.getElementsByClassName('btn btn-default free_send_button btn-disabled');
	var unlocked_levels = doc.getElementsByClassName('btn btn-default free_send_button');
	var free_levels = unlocked_levels.length - unfree_levels.length;

	if(free_levels == 0)
		alert('Brak dostępnych poziomów zbieractwa');
	else{ // If only Level 1 left and it is being skipped
		if(unlocked_levels.length > 1 && free_levels == 1 && settings.skip_level_1 == 1)
			alert('Ustawiono pominięcie 1 poziomu zbieractwa');
		else{
			if (split_method == 0){
				// Original code part and method by PabloCanaletto
				let unit;
				for(var i = 0; i<7; i++){
					if(settings.archers == 0)
						if(i==3 || i==5)
							i++;
					if(units_settings[i].max_unit_number > 0){
						unit = units[i];
						let field = $(`[name=${unit}]`);
						let available = Number(field[0].parentNode.children[1].innerText.match(/\d+/)[0]);
						
						if(available > units_settings[i].untouchable)
							available -= units_settings[i].untouchable;
						else
							available = 0;
						
						if(available >= units_settings[i].conditional_safeguard)
							available -= units_settings[i].conditional_safeguard;
						
						if(unlocked_levels.length == 1){
							if(available > units_settings[i].max_unit_number)
								available = units_settings[i].max_unit_number;
							to_send[i] = available;
						}
						else{
							let packs = 0;
							if(settings.skip_level_1 == 0)
								packs += 15;
							if(unlocked_levels.length >= 2)
								packs += 6;
							if(unlocked_levels.length >= 3)
								packs += 3;
							if(unlocked_levels.length == 4)
								packs += 2;
							
							let left_packs = 0;
							let packs_now;
							
							if(free_levels >= 1 && settings.skip_level_1 == 0){
								packs_now = 15;
								left_packs += 15;
							}
							if(free_levels >= 2){
								packs_now = 6;
								left_packs += 6;
							}
							if(free_levels >= 3){
								packs_now = 3;
								left_packs += 3;
							}
							if(free_levels ==4){
								packs_now = 2;
								left_packs += 2;
							}
							
							if(available*packs/left_packs > units_settings[i].max_unit_number)
								to_send[i] = units_settings[i].max_unit_number*packs_now/packs;
							else
								to_send[i] = available*packs_now/left_packs;
						}
					}
				}

				let capacity = 0;
				for(var i = 0; i<7; i++){
					if(settings.archers == 0)
						if(i==3 || i==5)
							i++;
					capacity += units_capacity[i] * to_send[i];
				}

				if(free_levels == 1){
					settings.max_ressources *= 10;
				}
				else if(free_levels == 2){
					settings.max_ressources *= 4;
				}
				else if(free_levels == 3){
					settings.max_ressources *= 2;
				}
				else{
					settings.max_ressources *= 1.3333;
				}

				if(capacity > settings.max_ressources){
					let ratio = settings.max_ressources / capacity;
					for(var i = 0; i<7; i++){
						if(settings.archers == 0)
							if(i==3 || i==5)
								i++;
						to_send[i] = to_send[i] * ratio;
					}
				}

				for(var i = 0; i<7; i++){
					if(settings.archers == 0)
						if(i==3 || i==5)
							i++;
					unit = units[i];
					fill(unit, Math.floor(to_send[i]));
				}
				
			
			} else if (split_method == 1){				
				var capacity_available = [0,0,0,0,0,0,0];
				var ratio_per_level    = [0,0,0,0];
				for(var i = 0; i<7; i++){ 
					// Calculate the total number of troops of each type
					// along with their capacity
					if(settings.archers == 0) // Skip archers if user said so
						if(i==3 || i==5)
							i++;
					if(units_settings[i].max_unit_number > 0){ // If user picks this units to send
						unit = units[i];
						let field = $(`[name=${unit}]`);

						// Get the troopcount from the game
						let available = Number(field[0].parentNode.children[1].innerText.match(/\d+/)[0]); 
						
						// Check if troopcount is higher than untouchable
						if(available > units_settings[i].untouchable)
							available -= units_settings[i].untouchable;
						else
							available = 0;
						
						// Substract conditional_safeguard troopcount
						if(available >= units_settings[i].conditional_safeguard)
							available -= units_settings[i].conditional_safeguard;
						
						// Limit available count if it is higher than max_unit_number
						if(available > units_settings[i].max_unit_number)
							available = units_settings[i].max_unit_number;
						
						// Write available troops into to_send list  		
						to_send[i] = available;
							
						// Translate max_unit_number into capacity_available
						capacity_available[i] = units_capacity[i] * to_send[i];
					}
				}

				const total_capacity_available = capacity_available.reduce((partialSum, a) => partialSum + a, 0);

				var ratio_per_level  = [0,0,0,0];

				const capacity_to_ratio_step = 1000;
				const capacity_to_ratio_list = [1000,2000,3000,4000,5000,6000,7000,8000,9000,10000,11000,12000,13000,14000,15000,16000,17000,18000,19000,20000,21000,22000,23000,24000,25000,26000,27000,28000,29000,30000,31000,32000,33000,34000,35000,36000,37000,38000,39000,40000,41000,42000,43000,44000,45000,46000,47000,48000,49000,50000,51000,52000,53000,54000,55000,56000,57000,58000,59000,60000,61000,62000,63000,64000,65000,66000,67000,68000,69000,70000,71000,72000,73000,74000,75000,76000,77000,78000,79000,80000,81000,82000,83000,84000,85000,86000,87000,88000,89000,90000,91000,92000,93000,94000,95000,96000,97000,98000,99000,100000,101000,102000,103000,104000,105000,106000,107000,108000,109000,110000,111000,112000,113000,114000,115000,116000,117000,118000,119000,120000,121000,122000,123000,124000,125000,126000,127000,128000,129000,130000,131000,132000,133000,134000,135000,136000,137000,138000,139000,140000,141000,142000,143000,144000,145000,146000,147000,148000,149000,150000,151000,152000,153000,154000,155000,156000,157000,158000,159000,160000,161000,162000,163000,164000,165000,166000,167000,168000,169000,170000,171000,172000,173000,174000,175000,176000,177000,178000,179000,180000,181000,182000,183000,184000,185000,186000,187000,188000,189000,190000,191000,192000,193000,194000,195000,196000,197000,198000,199000,200000,201000,202000,203000,204000,205000,206000,207000,208000,209000,210000,211000,212000,213000,214000,215000,216000,217000,218000,219000,220000,221000,222000,223000,224000,225000,226000,227000,228000,229000,230000,231000,232000,233000,234000,235000,236000,237000,238000,239000,240000,241000,242000,243000,244000,245000,246000,247000,248000,249000,250000,251000,252000,253000,254000,255000,256000,257000,258000,259000,260000,261000,262000,263000,264000,265000,266000,267000,268000,269000,270000,271000,272000,273000,274000,275000,276000,277000,278000,279000,280000,281000,282000,283000,284000,285000,286000,287000,288000,289000,290000,291000,292000,293000,294000,295000,296000,297000,298000,299000,300000,301000,302000,303000,304000,305000,306000,307000,308000,309000,310000,311000,312000,313000,314000,315000,316000,317000,318000,319000,320000,321000,322000,323000,324000,325000,326000,327000,328000,329000,330000,331000,332000,333000,334000,335000,336000,337000,338000,339000,340000,341000,342000,343000,344000,345000,346000,347000,348000,349000,350000];
				const level_1_ratios = [0.000000,0.000000,0.000000,0.000000,0.000000,0.027712,0.062533,0.090068,0.112180,0.130287,0.145377,0.158145,0.169092,0.178584,0.186894,0.194233,0.200764,0.206614,0.211885,0.216662,0.221010,0.224986,0.228637,0.232001,0.235111,0.237996,0.240679,0.243181,0.245520,0.247712,0.249771,0.251707,0.253533,0.255258,0.256889,0.258434,0.259901,0.261294,0.262620,0.263884,0.265088,0.266239,0.267339,0.268392,0.269400,0.270367,0.271295,0.272186,0.273043,0.273867,0.274661,0.275425,0.276163,0.276875,0.277562,0.278225,0.278867,0.279488,0.280089,0.280671,0.281235,0.281781,0.282311,0.282826,0.283325,0.283810,0.284282,0.284740,0.285185,0.285619,0.286041,0.286452,0.286852,0.287242,0.287622,0.287993,0.288354,0.288707,0.289051,0.289387,0.289715,0.290036,0.290349,0.290655,0.290955,0.291247,0.291534,0.291814,0.292088,0.292357,0.292620,0.292877,0.293129,0.293376,0.293619,0.293856,0.294089,0.294317,0.294541,0.294760,0.294976,0.295187,0.295395,0.295599,0.295799,0.295995,0.296188,0.296378,0.296564,0.296748,0.296928,0.297104,0.297278,0.297450,0.297618,0.297783,0.297946,0.298106,0.298264,0.298419,0.298572,0.298722,0.298870,0.299016,0.299160,0.299301,0.299440,0.299578,0.299713,0.299846,0.299977,0.300107,0.300234,0.300360,0.300484,0.300606,0.300727,0.300846,0.300963,0.301079,0.301193,0.301305,0.301416,0.301526,0.301634,0.301741,0.301847,0.301951,0.302053,0.302155,0.302255,0.302354,0.302452,0.302548,0.302643,0.302738,0.302831,0.302922,0.303013,0.303103,0.303192,0.303279,0.303366,0.303451,0.303536,0.303620,0.303702,0.303784,0.303865,0.303945,0.304024,0.304102,0.304180,0.304256,0.304332,0.304406,0.304480,0.304554,0.304626,0.304698,0.304769,0.304839,0.304909,0.304977,0.305045,0.305113,0.305179,0.305245,0.305311,0.305375,0.305439,0.305503,0.305566,0.305628,0.305689,0.305750,0.305811,0.305871,0.305930,0.305988,0.306047,0.306104,0.306161,0.306218,0.306274,0.306329,0.306384,0.306439,0.306493,0.306546,0.306599,0.306652,0.306704,0.306755,0.306806,0.306857,0.306907,0.306957,0.307006,0.307055,0.307104,0.307152,0.307200,0.307247,0.307294,0.307340,0.307386,0.307432,0.307478,0.307522,0.307567,0.307611,0.307655,0.307699,0.307742,0.307785,0.307827,0.307869,0.307911,0.307953,0.307994,0.308035,0.308075,0.308115,0.308155,0.308195,0.308234,0.308273,0.308312,0.308350,0.308388,0.308426,0.308463,0.308501,0.308538,0.308574,0.308611,0.308647,0.308683,0.308718,0.308754,0.308789,0.308824,0.308858,0.308893,0.308927,0.308961,0.308994,0.309028,0.309061,0.309094,0.309126,0.309159,0.309191,0.309223,0.309255,0.309286,0.309318,0.309349,0.309380,0.309411,0.309441,0.309471,0.309502,0.309531,0.309561,0.309591,0.309620,0.309649,0.309678,0.309707,0.309735,0.309764,0.309792,0.309820,0.309848,0.309875,0.309903,0.309930,0.309957,0.309984,0.310011,0.310038,0.310064,0.310090,0.310117,0.310143,0.310168,0.310194,0.310219,0.310245,0.310270,0.310295,0.310320,0.310345,0.310369,0.310394,0.310418,0.310442,0.310466,0.310490,0.310514,0.310537,0.310561,0.310584,0.310607,0.310630,0.310653,0.310676,0.310698,0.310721,0.310743,0.310766,0.310788,0.310810,0.310832,0.310853,0.310875,0.310896,0.310918,0.310939,0.310960,0.310981,0.311002,0.311023,0.311044,0.311064,0.311085,0.311105,0.311125];
				const level_2_ratios = [0.019232,0.189647,0.252996,0.286121,0.306600,0.310136,0.307054,0.304255,0.301853,0.299804,0.298048,0.296530,0.295206,0.294044,0.293015,0.292097,0.291275,0.290532,0.289860,0.289247,0.288686,0.288172,0.287697,0.287259,0.286852,0.286473,0.286120,0.285790,0.285481,0.285191,0.284917,0.284660,0.284417,0.284187,0.283969,0.283762,0.283565,0.283378,0.283200,0.283030,0.282868,0.282713,0.282565,0.282423,0.282286,0.282156,0.282030,0.281909,0.281793,0.281681,0.281573,0.281469,0.281369,0.281272,0.281179,0.281088,0.281001,0.280916,0.280834,0.280755,0.280678,0.280603,0.280531,0.280460,0.280392,0.280326,0.280261,0.280198,0.280137,0.280078,0.280020,0.279964,0.279909,0.279855,0.279803,0.279752,0.279702,0.279654,0.279606,0.279560,0.279515,0.279471,0.279428,0.279386,0.279344,0.279304,0.279265,0.279226,0.279188,0.279151,0.279115,0.279080,0.279045,0.279011,0.278977,0.278944,0.278912,0.278881,0.278850,0.278819,0.278790,0.278760,0.278732,0.278704,0.278676,0.278649,0.278622,0.278596,0.278570,0.278545,0.278520,0.278495,0.278471,0.278448,0.278424,0.278401,0.278379,0.278357,0.278335,0.278313,0.278292,0.278271,0.278251,0.278230,0.278211,0.278191,0.278172,0.278153,0.278134,0.278115,0.278097,0.278079,0.278061,0.278044,0.278027,0.278010,0.277993,0.277977,0.277960,0.277944,0.277928,0.277913,0.277897,0.277882,0.277867,0.277852,0.277838,0.277823,0.277809,0.277795,0.277781,0.277767,0.277753,0.277740,0.277727,0.277714,0.277701,0.277688,0.277675,0.277663,0.277650,0.277638,0.277626,0.277614,0.277603,0.277591,0.277579,0.277568,0.277557,0.277546,0.277535,0.277524,0.277513,0.277502,0.277492,0.277481,0.277471,0.277461,0.277451,0.277441,0.277431,0.277421,0.277411,0.277402,0.277392,0.277383,0.277374,0.277364,0.277355,0.277346,0.277337,0.277329,0.277320,0.277311,0.277303,0.277294,0.277286,0.277277,0.277269,0.277261,0.277253,0.277245,0.277237,0.277229,0.277221,0.277213,0.277206,0.277198,0.277191,0.277183,0.277176,0.277168,0.277161,0.277154,0.277147,0.277140,0.277133,0.277126,0.277119,0.277112,0.277105,0.277099,0.277092,0.277085,0.277079,0.277072,0.277066,0.277059,0.277053,0.277047,0.277041,0.277034,0.277028,0.277022,0.277016,0.277010,0.277004,0.276998,0.276993,0.276987,0.276981,0.276975,0.276970,0.276964,0.276958,0.276953,0.276947,0.276942,0.276937,0.276931,0.276926,0.276921,0.276915,0.276910,0.276905,0.276900,0.276895,0.276890,0.276885,0.276880,0.276875,0.276870,0.276865,0.276860,0.276855,0.276851,0.276846,0.276841,0.276837,0.276832,0.276827,0.276823,0.276818,0.276814,0.276809,0.276805,0.276800,0.276796,0.276792,0.276787,0.276783,0.276779,0.276774,0.276770,0.276766,0.276762,0.276758,0.276754,0.276750,0.276746,0.276742,0.276738,0.276734,0.276730,0.276726,0.276722,0.276718,0.276714,0.276710,0.276707,0.276703,0.276699,0.276695,0.276692,0.276688,0.276684,0.276681,0.276677,0.276673,0.276670,0.276666,0.276663,0.276659,0.276656,0.276652,0.276649,0.276645,0.276642,0.276639,0.276635,0.276632,0.276629,0.276625,0.276622,0.276619,0.276616,0.276612,0.276609,0.276606,0.276603,0.276600,0.276597,0.276593,0.276590,0.276587,0.276584,0.276581,0.276578,0.276575,0.276572,0.276569,0.276566,0.276563,0.276560,0.276557,0.276554,0.276552,0.276549,0.276546,0.276543];
				const level_3_ratios = [0.406521,0.367395,0.351536,0.343061,0.337763,0.325718,0.312450,0.302025,0.293680,0.286861,0.281185,0.276388,0.272278,0.268718,0.265602,0.262851,0.260404,0.258213,0.256239,0.254452,0.252824,0.251336,0.249971,0.248712,0.247549,0.246470,0.245467,0.244532,0.243657,0.242838,0.242069,0.241345,0.240662,0.240018,0.239409,0.238831,0.238283,0.237763,0.237267,0.236795,0.236345,0.235916,0.235505,0.235112,0.234735,0.234374,0.234028,0.233695,0.233375,0.233067,0.232771,0.232485,0.232210,0.231944,0.231687,0.231440,0.231200,0.230968,0.230744,0.230527,0.230316,0.230112,0.229914,0.229722,0.229536,0.229355,0.229179,0.229008,0.228841,0.228680,0.228522,0.228369,0.228219,0.228074,0.227932,0.227794,0.227659,0.227527,0.227399,0.227273,0.227151,0.227031,0.226914,0.226800,0.226688,0.226579,0.226472,0.226367,0.226265,0.226165,0.226067,0.225971,0.225877,0.225784,0.225694,0.225606,0.225519,0.225434,0.225350,0.225268,0.225188,0.225109,0.225031,0.224955,0.224881,0.224807,0.224735,0.224664,0.224595,0.224527,0.224459,0.224393,0.224328,0.224265,0.224202,0.224140,0.224079,0.224020,0.223961,0.223903,0.223846,0.223790,0.223735,0.223680,0.223627,0.223574,0.223522,0.223471,0.223420,0.223371,0.223322,0.223273,0.223226,0.223179,0.223133,0.223087,0.223042,0.222998,0.222954,0.222911,0.222868,0.222826,0.222785,0.222744,0.222703,0.222664,0.222624,0.222585,0.222547,0.222509,0.222472,0.222435,0.222398,0.222362,0.222327,0.222292,0.222257,0.222223,0.222189,0.222155,0.222122,0.222090,0.222057,0.222025,0.221994,0.221963,0.221932,0.221901,0.221871,0.221841,0.221812,0.221783,0.221754,0.221725,0.221697,0.221669,0.221642,0.221614,0.221587,0.221561,0.221534,0.221508,0.221482,0.221456,0.221431,0.221406,0.221381,0.221356,0.221332,0.221308,0.221284,0.221260,0.221237,0.221214,0.221191,0.221168,0.221145,0.221123,0.221101,0.221079,0.221057,0.221036,0.221015,0.220994,0.220973,0.220952,0.220932,0.220911,0.220891,0.220871,0.220851,0.220832,0.220812,0.220793,0.220774,0.220755,0.220736,0.220718,0.220699,0.220681,0.220663,0.220645,0.220627,0.220610,0.220592,0.220575,0.220558,0.220541,0.220524,0.220507,0.220490,0.220474,0.220457,0.220441,0.220425,0.220409,0.220393,0.220378,0.220362,0.220346,0.220331,0.220316,0.220301,0.220286,0.220271,0.220256,0.220242,0.220227,0.220213,0.220198,0.220184,0.220170,0.220156,0.220142,0.220128,0.220115,0.220101,0.220088,0.220074,0.220061,0.220048,0.220035,0.220022,0.220009,0.219996,0.219983,0.219971,0.219958,0.219946,0.219933,0.219921,0.219909,0.219897,0.219885,0.219873,0.219861,0.219849,0.219837,0.219826,0.219814,0.219803,0.219791,0.219780,0.219769,0.219758,0.219747,0.219736,0.219725,0.219714,0.219703,0.219692,0.219682,0.219671,0.219660,0.219650,0.219640,0.219629,0.219619,0.219609,0.219599,0.219589,0.219579,0.219569,0.219559,0.219549,0.219539,0.219530,0.219520,0.219510,0.219501,0.219492,0.219482,0.219473,0.219464,0.219454,0.219445,0.219436,0.219427,0.219418,0.219409,0.219400,0.219391,0.219382,0.219374,0.219365,0.219356,0.219348,0.219339,0.219331,0.219322,0.219314,0.219306,0.219297,0.219289,0.219281,0.219273,0.219265,0.219257,0.219249,0.219241,0.219233,0.219225,0.219217,0.219209,0.219201,0.219194,0.219186,0.219178,0.219171,0.219163];
				const level_4_ratios = [0.574247,0.442958,0.395468,0.370818,0.355638,0.336435,0.317963,0.303652,0.292287,0.283048,0.275390,0.268937,0.263423,0.258655,0.254489,0.250818,0.247557,0.244641,0.242015,0.239640,0.237479,0.235506,0.233695,0.232028,0.230488,0.229061,0.227734,0.226497,0.225341,0.224259,0.223243,0.222288,0.221388,0.220538,0.219734,0.218973,0.218250,0.217564,0.216912,0.216291,0.215698,0.215132,0.214591,0.214074,0.213579,0.213104,0.212648,0.212210,0.211790,0.211385,0.210995,0.210620,0.210258,0.209909,0.209572,0.209247,0.208932,0.208627,0.208333,0.208048,0.207771,0.207504,0.207244,0.206992,0.206747,0.206509,0.206279,0.206054,0.205836,0.205624,0.205417,0.205216,0.205020,0.204829,0.204643,0.204462,0.204285,0.204112,0.203944,0.203779,0.203619,0.203462,0.203309,0.203159,0.203013,0.202869,0.202729,0.202592,0.202458,0.202327,0.202198,0.202073,0.201949,0.201829,0.201710,0.201594,0.201480,0.201369,0.201259,0.201152,0.201047,0.200943,0.200842,0.200742,0.200645,0.200549,0.200454,0.200362,0.200271,0.200181,0.200093,0.200007,0.199922,0.199838,0.199756,0.199675,0.199596,0.199518,0.199441,0.199365,0.199290,0.199217,0.199145,0.199073,0.199003,0.198934,0.198866,0.198799,0.198733,0.198668,0.198604,0.198541,0.198479,0.198417,0.198357,0.198297,0.198238,0.198180,0.198123,0.198067,0.198011,0.197956,0.197902,0.197848,0.197795,0.197743,0.197692,0.197641,0.197591,0.197541,0.197492,0.197444,0.197397,0.197349,0.197303,0.197257,0.197212,0.197167,0.197123,0.197079,0.197036,0.196993,0.196951,0.196909,0.196867,0.196827,0.196786,0.196746,0.196707,0.196668,0.196629,0.196591,0.196554,0.196516,0.196479,0.196443,0.196407,0.196371,0.196336,0.196301,0.196266,0.196232,0.196198,0.196165,0.196131,0.196099,0.196066,0.196034,0.196002,0.195970,0.195939,0.195908,0.195878,0.195847,0.195817,0.195788,0.195758,0.195729,0.195700,0.195672,0.195643,0.195615,0.195587,0.195560,0.195532,0.195505,0.195479,0.195452,0.195426,0.195400,0.195374,0.195348,0.195323,0.195298,0.195273,0.195248,0.195224,0.195199,0.195175,0.195151,0.195128,0.195104,0.195081,0.195058,0.195035,0.195013,0.194990,0.194968,0.194946,0.194924,0.194902,0.194880,0.194859,0.194838,0.194817,0.194796,0.194775,0.194755,0.194734,0.194714,0.194694,0.194674,0.194654,0.194635,0.194615,0.194596,0.194577,0.194558,0.194539,0.194520,0.194502,0.194484,0.194465,0.194447,0.194429,0.194411,0.194393,0.194376,0.194358,0.194341,0.194324,0.194307,0.194290,0.194273,0.194256,0.194239,0.194223,0.194207,0.194190,0.194174,0.194158,0.194142,0.194126,0.194111,0.194095,0.194080,0.194064,0.194049,0.194034,0.194019,0.194004,0.193989,0.193974,0.193959,0.193945,0.193930,0.193916,0.193902,0.193888,0.193873,0.193859,0.193846,0.193832,0.193818,0.193804,0.193791,0.193777,0.193764,0.193751,0.193737,0.193724,0.193711,0.193698,0.193685,0.193673,0.193660,0.193647,0.193635,0.193622,0.193610,0.193597,0.193585,0.193573,0.193561,0.193549,0.193537,0.193525,0.193513,0.193501,0.193490,0.193478,0.193466,0.193455,0.193444,0.193432,0.193421,0.193410,0.193399,0.193387,0.193376,0.193365,0.193355,0.193344,0.193333,0.193322,0.193312,0.193301,0.193290,0.193280,0.193270,0.193259,0.193249,0.193239,0.193228,0.193218,0.193208,0.193198,0.193188,0.193178,0.193169];

				if (total_capacity_available >= capacity_to_ratio_list[capacity_to_ratio_list.length - 1]){
					// If you send more troops than arrays assumed you might wish to, pick last ratio
					ratio_per_level[0] = level_1_ratios[capacity_to_ratio_list.length - 1];
					ratio_per_level[1] = level_2_ratios[capacity_to_ratio_list.length - 1];
					ratio_per_level[2] = level_3_ratios[capacity_to_ratio_list.length - 1];
					ratio_per_level[3] = level_4_ratios[capacity_to_ratio_list.length - 1];
				} else {
					const postIdx = capacity_to_ratio_list.findIndex((element) => element > total_capacity_available);
					if (postIdx == 0){
						// If you send less troops than arrays assumed you might wish to, pick first ratio
						ratio_per_level[0] = level_1_ratios[0];
						ratio_per_level[1] = level_2_ratios[0];
						ratio_per_level[2] = level_3_ratios[0];
						ratio_per_level[3] = level_4_ratios[0];
					} else {
						// Calculate "perfect" ratio as an interpolation over prepared arrays
						const preIdx = postIdx - 1;
						const mtp = total_capacity_available%capacity_to_ratio_step/capacity_to_ratio_step;
						const ovfl_level1 = (level_1_ratios[postIdx] - level_1_ratios[preIdx])*mtp;
						const ovfl_level2 = (level_2_ratios[postIdx] - level_2_ratios[preIdx])*mtp;
						const ovfl_level3 = (level_3_ratios[postIdx] - level_3_ratios[preIdx])*mtp;
						const ovfl_level4 = (level_4_ratios[postIdx] - level_4_ratios[preIdx])*mtp;
						ratio_per_level[0] = level_1_ratios[preIdx] + ovfl_level1;
						ratio_per_level[1] = level_2_ratios[preIdx] + ovfl_level2;
						ratio_per_level[2] = level_3_ratios[preIdx] + ovfl_level3;
						ratio_per_level[3] = level_4_ratios[preIdx] + ovfl_level4;
					}
				}

				// Normalize the ratio over the levels available 
				const ratio_normalizer = ratio_per_level.reduce((partialSum, a) => partialSum + a, 0);
				ratio_per_level[0] /= ratio_normalizer;
				ratio_per_level[1] /= ratio_normalizer;
				ratio_per_level[2] /= ratio_normalizer;
				ratio_per_level[3] /= ratio_normalizer;

				for(var i = 0; i<7; i++){
					if(free_levels >= 1 && settings.skip_level_1 == 0){
						to_send[i] = to_send[i]*ratio_per_level[0];
						settings.max_ressources *= 10;
					}
					if(free_levels >= 2){
						to_send[i] = to_send[i]*ratio_per_level[1];
						settings.max_ressources *= 4;
					}
					if(free_levels >= 3){
						to_send[i] = to_send[i]*ratio_per_level[2];
						settings.max_ressources *= 2;
					}
					if(free_levels ==4){
						to_send[i] = to_send[i]*ratio_per_level[3];
						settings.max_ressources *= 1.3333;
					}
					if(capacity_available[i] > settings.max_ressources){
						let ratio = settings.max_ressources / capacity;
						for(var i = 0; i<7; i++){
							if(settings.archers == 0)
								if(i==3 || i==5)
									i++;
							to_send[i] = to_send[i] * ratio;
						}
					}

					for(var i = 0; i<7; i++){
						if(settings.archers == 0)
							if(i==3 || i==5)
								i++;
						unit = units[i];
						fill(unit, Math.floor(to_send[i]));
					}	
				}
			}
		}
	}
}








